version: 2

models:
  - name: dim_providers
    description: "Dimension table for providers"
    columns:
      - name: dim_provider_pk
        description: "Primary key for the providers dimension"
        tests:
          - unique
          - not_null

  - name: dim_plans
    description: "Dimension table for subscription plans"
    columns:
      - name: dim_plan_pk
        description: "Primary key for the plans dimension"
        tests:
          - unique
          - not_null
      - name: price
        description: "Price of the subscription plan"
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 2000
              
  - name: dim_users
    description: "Dimension table for users"
    columns:
      - name: dim_user_pk
        description: "Primary key for the users dimension"
        tests:
          - unique
          - not_null
      - name: email
        description: "User's email address"
        tests:
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: r"^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$"

  - name: fct_subscriptions
    description: "Fact table for subscriptions"
    columns:
      - name: subscription_id
        description: "Primary key for the subscriptions fact table"
        tests:
          - unique
          - not_null
      - name: dim_plan_fk
        description: "Foreign key to the plans dimension"
        tests:
          - relationships:
              to: ref('dim_plans')
              field: dim_plan_pk
      - name: dim_user_fk
        description: "Foreign key to the users dimension"
        tests:
          - relationships:
              to: ref('dim_users')
              field: dim_user_pk
      - name: dim_provider_fk
        description: "Foreign key to the providers dimension"
        tests:
          - relationships:
              to: ref('dim_providers')
              field: dim_provider_pk

  - name: mart_subscriptions_external
    description: "External-facing data mart with PII-free data for external clients."
    columns:
      - name: subscription_id
        description: "Primary key for the subscription"
        tests:
          - not_null

  - name: mart_subscriptions_internal
    description: "Internal-facing data mart with all available data for in-depth analysis."
    columns:
      - name: subscription_id
        description: "Primary key for the subscription"
        tests:
          - not_null
